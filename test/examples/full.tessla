define writes: Events<Int> := variable_updates("main.c:write_ptr")
define processed: Events<Int> := function_calls("main.c:process")

define bufLevel: Signal<Int> := diff(count(writes), count(processed))

define error: Events<Unit> := onFalse(and(leq(0,bufLevel), leq(bufLevel,5)))

-- out error

Definitions(
  Map(
    "writes" -> StreamDef(
      "writes",
      ExprTree(
        Map(Pos(0) -> ExprTree(
          NamedFn("variable_updates"),
          Map(
            Pos(0) ->
            ExprTree(LiteralFn(StringLiteral("main.c: write_ptr")), Map())),

          )),
          "processed" -> StreamDef(
            "processed",
            SourceLoc((2, 1 - 2, 66)),
            ExprTree(
              TypeAscrFn(GenericType("Events",
                List(SimpleType("Int"))), SourceLoc((2, 19 - 2, 30))),
                Map(Pos(0) -> ExprTree(NamedFn("function_calls",
                  SourceLoc((2, 34 - 2, 48))), Map(Pos(0) ->
                  ExprTree(LiteralFn(StringLiteral("main.c: process"), SourceLoc((2, 49 -
                    2, 65))), Map(), SourceLoc((2, 49 - 2, 65)))), SourceLoc((2, 1 - 2, 66)))),
                    SourceLoc((2, 1 - 2, 66))
                  )),
                  "bufLevel" -> StreamDef(
                    "bufLevel",
                    SourceLoc((4, 1 - 4, 70)),
                    ExprTree(
                      TypeAscrFn(GenericType("Signal",
                        List(SimpleType("Int"))), SourceLoc((4, 18 - 4, 29))),
                        Map(Pos(0) -> ExprTree(NamedFn("diff",
                          SourceLoc((4, 33 - 4, 37))), Map(Pos(0) -> ExprTree(NamedFn("count",
                            SourceLoc((4, 38 - 4, 43))), Map(Pos(0) -> ExprTree(NamedFn("writes",
                              SourceLoc((4, 44 - 4, 50))), Map(), SourceLoc((4, 44 - 4, 50)))),
                              SourceLoc((4, 1 - 4, 70))), Pos(1) -> ExprTree(NamedFn("count",
                                SourceLoc((4, 53 - 4, 58))), Map(Pos(0) -> ExprTree(NamedFn("processed",
                                  SourceLoc((4, 59 - 4, 68))), Map(), SourceLoc((4, 59 - 4, 68)))),
                                  SourceLoc((4, 1 - 4, 70)))), SourceLoc((4, 1 - 4, 70)))),
                                  SourceLoc((4, 1 - 4, 70)))),
                                  "error" -> StreamDef(
                                    "error",
                                    SourceLoc((6, 1 - 6, 77)),
                                    ExprTree(
                                      TypeAscrFn(GenericType("Events",
                                        List(SimpleType("Unit"))), SourceLoc((6, 15 - 6, 27))),
                                        Map(Pos(0) -> ExprTree(NamedFn("onFalse",
                                          SourceLoc((6, 31 - 6, 38))), Map(Pos(0) -> ExprTree(NamedFn(and,
                                            SourceLoc((6, 39 - 6, 42))), Map(Pos(0) -> ExprTree(NamedFn("leq",
                                              SourceLoc((6, 43 - 6, 46))), Map(Pos(0) ->
                                              ExprTree(LiteralFn(IntLiteral(0), SourceLoc((6, 47 - 6, 48))), Map(),
                                              SourceLoc((6, 47 - 6, 48))), Pos(1) -> ExprTree(NamedFn("bufLevel",
                                                SourceLoc((6, 49 - 6, 57))), Map(), SourceLoc((6, 49 - 6, 57)))),
                                                SourceLoc((6, 1 - 6, 77))), Pos(1) -> ExprTree(NamedFn("leq",
                                                  SourceLoc((6, 60 - 6, 63))), Map(Pos(0) -> ExprTree(NamedFn("bufLevel",
                                                    SourceLoc((6, 64 - 6, 72))), Map(), SourceLoc((6, 64 - 6, 72))), Pos(1)
                                                    -> ExprTree(LiteralFn(IntLiteral(5), SourceLoc((6, 73 - 6, 74))), Map(),
                                                    SourceLoc((6, 73 - 6, 74)))), SourceLoc((6, 1 - 6, 77)))), SourceLoc((6,
                                                      1 - 6, 77)))), SourceLoc((6, 1 - 6, 77)))),
                                                      SourceLoc((6, 1 - 6, 77))
                                                    ))
                                                  ),
                                                  Map()
                                                )
